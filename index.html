<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat Roulette</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .searching {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .connected {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .controls {
            margin: 30px 0;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .call-controls {
            display: none;
            margin-top: 20px;
        }

        .user-info {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        #localVideo, #remoteVideo {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            margin: 10px 0;
            background: #000;
        }

        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .video-wrapper {
            text-align: center;
        }

        .video-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ –ß–∞—Ç-–†—É–ª–µ—Ç–∫–∞</h1>
        <div class="user-info">
            <p id="userStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ Telegram</p>
        </div>
        
        <div id="status" class="status searching">
            –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
        </div>

        <div class="controls">
            <button id="startBtn" onclick="startSearch()">üîç –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫</button>
            <button id="stopBtn" onclick="stopSearch()" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="nextBtn" onclick="nextPartner()" disabled>‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π</button>
        </div>

        <div class="call-controls" id="callControls">
            <button id="callBtn" onclick="startCall()">üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button id="endCallBtn" onclick="endCall()" disabled>üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button id="muteBtn" onclick="toggleMute()">üîá –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
        </div>

        <div class="video-container" id="videoContainer" style="display: none;">
            <div class="video-wrapper">
                <div class="video-label">–í—ã</div>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div class="video-wrapper">
                <div class="video-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
    </div>

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        const tg = window.Telegram.WebApp;
        let currentPartner = null;
        let isSearching = false;
        let isInCall = false;
        let localStream = null;
        let peerConnection = null;
        let isMuted = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.expand();
        tg.enableClosingConfirmation();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            document.getElementById('userStatus').textContent = 
                `–ü—Ä–∏–≤–µ—Ç, ${user.first_name} ${user.last_name || ''} (@${user.username || '–±–µ–∑ username'})`;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å WebRTC
        async function startSearch() {
            if (isSearching) return;
            
            isSearching = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').textContent = 'üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';
            document.getElementById('status').className = 'status searching';

            try {
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                const response = await fetch('/api/find_partner', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: tg.initDataUnsafe.user?.id,
                        username: tg.initDataUnsafe.user?.username
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentPartner = data.partner;
                    connectToPartner();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                stopSearch();
            }
        }

        function stopSearch() {
            isSearching = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('status').textContent = '–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            
            if (currentPartner) {
                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞
                fetch('/api/stop_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: tg.initDataUnsafe.user?.id
                    })
                });
            }
        }

        function nextPartner() {
            if (isInCall) {
                endCall();
            }
            stopSearch();
            setTimeout(startSearch, 1000);
        }

        function connectToPartner() {
            document.getElementById('status').textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`;
            document.getElementById('status').className = 'status connected';
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('callControls').style.display = 'block';
        }

        async function startCall() {
            if (!currentPartner || isInCall) return;

            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('videoContainer').style.display = 'flex';
                document.getElementById('callBtn').disabled = true;
                document.getElementById('endCallBtn').disabled = false;

                isInCall = true;

                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                await initializeWebRTC();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }

        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('callBtn').disabled = false;
            document.getElementById('endCallBtn').disabled = true;

            isInCall = false;
        }

        function toggleMute() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isMuted = !isMuted;
                document.getElementById('muteBtn').textContent = 
                    isMuted ? 'üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫' : 'üîá –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
            }
        }

        // –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        async function initializeWebRTC() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };

            peerConnection = new RTCPeerConnection(configuration);

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –æ–±–º–µ–Ω–∞ SDP —á–µ—Ä–µ–∑ signaling —Å–µ—Ä–≤–µ—Ä
            // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (isSearching || isInCall) {
                stopSearch();
                endCall();
            }
        });
    </script>
</body>
</html>
